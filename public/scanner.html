<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Scanner QR | Leonessa Cup</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-family: 'Righteous', sans-serif;
      background-color: #141A33;
      color: aliceblue;
    }
    #reader {
      width: 300px;
      height: 300px;
      margin-bottom: 20px;
    }
    #result {
      font-size: 16px;
      text-align: center;
    }
  </style>
</head>
<body>
<h2>Scanner Ingresso</h2>
<div id="reader"></div>
<div id="result">Scansiona un QR Code...</div>

<script>
  function isLoggedIn() {
    const loggedInAdmin = localStorage.getItem('loggedInAdmin');
    return loggedInAdmin !== null;
  }
  if (isLoggedIn()) {
    //distruggi il localStorage
    localStorage.removeItem('loggedInAdmin');
  } else {
    // Se l'utente non è loggato, reindirizza alla pagina di login
    window.location.href = '/logStaff';
  }
  let selector = document.getElementById('mySelector');
  // Funzione per caricare il contenuto dinamico in base alla selezione
  function loadContent(option) {
    const contentDiv = document.getElementById('content');
    contentDiv.innerHTML = ''; // Pulisce il contenuto precedente

    switch (option) {
      case 'option1':
        contentDiv.innerHTML = classifica();
        // Aggiungi un listener per il submit del form
        document.getElementById('updateClassificaForm').addEventListener('submit', async function(event) {
          event.preventDefault();

          // Collect input values
          const idSquadra = document.getElementById('id_squadra').value;
          const punti = document.getElementById('punti').value;
          const partiteGiocate = document.getElementById('partite_giocate').value;
          const vittorie = document.getElementById('vittorie').value;
          const pareggi = document.getElementById('pareggi').value;
          const sconfitte = document.getElementById('sconfitte').value;
          const golFatti = document.getElementById('gol_fatti').value;
          const golSubiti = document.getElementById('gol_subiti').value;
          console.log(idSquadra)
          console.log('Form submitted with values:', {
            tempId,
            punti,
            partiteGiocate,
            vittorie,
            pareggi,
            sconfitte,
            golFatti,
            golSubiti
          });
          try {
            const response = await fetch('/api/classifica/update', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                id_squadra: tempId,
                punti: punti,
                partite_giocate: partiteGiocate,
                vittorie: vittorie,
                pareggi: pareggi,
                sconfitte: sconfitte,
                gol_fatti: golFatti,
                gol_subiti: golSubiti
              })
            });

            if (response.ok) {
              alert('Classifica updated successfully!');
            } else {
              const contentType = response.headers.get('Content-Type');
              if (contentType && contentType.includes('application/json')) {
                const errorData = await response.json();
                alert(`Error: ${errorData.message || 'Failed to update classifica'}`);
              } else {
                const errorText = await response.text();
                alert(`Error: ${errorText}`);
              }
            }
          } catch (error) {
            console.error('Error:', error);
            alert('An error occurred while updating the classifica.');
          }
        });
        // aggiorna i dati nel input quando seleziona id squadra
        document.getElementById('id_squadra').addEventListener('change', async function() {
          console.log('ID Squadra selezionato:', this.value);
          const idSquadra = this.value;
          let dataClassifica = [];
          // Qui puoi aggiungere la logica per caricare i dati della squadra selezionata
          await fetch('/api/classifica/Data')
                  .then(response => {
                    if (!response.ok) {
                      throw new Error('Network response was not ok');
                    }
                    return response.json();
                  })
                  .then(data => {
                    dataClassifica = data;
                    console.log('Dati della classifica caricati:', dataClassifica);
                  })
                  .catch(err => console.error('Error loading classifica data:', err));
          for (let i = 0; i < dataClassifica.length; i++) {
            if (dataClassifica[i].nome_scuola.toUpperCase() === idSquadra.toUpperCase()) {
              document.getElementById('punti').value = dataClassifica[i].punti;
              document.getElementById('partite_giocate').value = dataClassifica[i].partite_giocate;
              document.getElementById('vittorie').value = dataClassifica[i].vittorie;
              document.getElementById('pareggi').value = dataClassifica[i].pareggi;
              document.getElementById('sconfitte').value = dataClassifica[i].sconfitte;
              document.getElementById('gol_fatti').value = dataClassifica[i].gol_fatti;
              document.getElementById('gol_subiti').value = dataClassifica[i].gol_subiti;
              tempId = dataClassifica[i].id_squadra;
            }
          }
        });
        break;
      case 'option2':
        contentDiv.innerHTML = evento();
        // giocatori
        // Aggiungi un listener per il submit del form
        document.getElementById('createEventForm').addEventListener('submit', async function(event) {
          event.preventDefault();

          // Collect input values
          const evento = document.getElementById('evento').value;
          const idGiocatore = document.getElementById('id_giocatore').value;
          const minuto = document.getElementById('minuto').value;
          const idPartita = document.getElementById('id_partita').value;

          console.log('Form submitted with values:', {
            evento,
            idGiocatore,
            minuto,
            idPartita
          });

          try {
            const response = await fetch('/api/evento/create', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                evento: evento,
                id_giocatore: idGiocatore,
                minuto: minuto,
                id_partita: idPartita
              })
            });

            if (response.ok) {
              alert('Evento created successfully!');
            } else {
              const contentType = response.headers.get('Content-Type');
              if (contentType && contentType.includes('application/json')) {
                const errorData = await response.json();
                alert(`Error: ${errorData.message || 'Failed to create evento'}`);
              } else {
                const errorText = await response.text();
                alert(`Error: ${errorText}`);
              }
            }
          } catch (error) {
            console.error('Error:', error);
            alert('An error occurred while creating the evento.');
          }
        });
        break;
      case 'option3':
        contentDiv.innerHTML = partita();
        // Aggiungi un listener per il submit del form
        document.getElementById('updateMatchForm').addEventListener('submit', async function(event) {
          event.preventDefault();

          // Collect input values
          const idPartita = document.getElementById('id_partita').value;
          const golCasa = document.getElementById('gol_casa').value;
          const golOspite = document.getElementById('gol_ospite').value;

          console.log('Form submitted with values:', {
            idPartita,
            golCasa,
            golOspite
          });

          try {
            const response = await fetch('/api/partite/updateMatch', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                id_partita: idPartita,
                gol_casa: golCasa,
                gol_ospite: golOspite
              })
            });

            if (response.ok) {
              alert('Match updated successfully!');
            } else {
              const contentType = response.headers.get('Content-Type');
              if (contentType && contentType.includes('application/json')) {
                const errorData = await response.json();
                alert(`Error: ${errorData.message || 'Failed to update match'}`);
              } else {
                const errorText = await response.text();
                alert(`Error: ${errorText}`);
              }
            }
          } catch (error) {
            console.error('Error:', error);
            alert('An error occurred while updating the match.');
          }
        });
        break;
      case 'option4':
        contentDiv.innerHTML = prestazione();
        // Aggiungi un listener per il submit del form
        document.getElementById('createPerformanceForm').addEventListener('submit', async function(event) {
          event.preventDefault();

          // Collect input values
          const idPartita = document.getElementById('id_partita').value;
          const idGiocatore = document.getElementById('id_giocatore').value;
          const minutiGiocati = document.getElementById('minuti_giocati').value;
          const gol = document.getElementById('gol').value;
          const assist = document.getElementById('assist').value;
          const cartelliniGialli = document.getElementById('cartellini_gialli').value;
          const cartelliniRossi = document.getElementById('cartellini_rossi').value;
          const titolare = document.getElementById('titolare').checked;
          const note = document.getElementById('note').value;
          const evento = document.getElementById('evento').value;

          console.log('Form submitted with values:', {
            idPartita,
            idGiocatore,
            minutiGiocati,
            gol,
            assist,
            cartelliniGialli,
            cartelliniRossi,
            titolare,
            note,
            evento
          });

          try {
            const response = await fetch('/api/prestazioni/create', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                id_partita: idPartita,
                id_giocatore: idGiocatore,
                minuti_giocati: minutiGiocati,
                gol: gol,
                assist: assist,
                cartellini_gialli: cartelliniGialli,
                cartellini_rossi: cartelliniRossi,
                titolare: titolare,
                note: note,
                evento: evento
              })
            });

            if (response.ok) {
              alert('Prestazione aggiunta con successo!');
            } else {
              const errorText = await response.text();
              alert(`Errore: ${errorText}`);
            }
          } catch (error) {
            console.error('Error:', error);
            alert('Si è verificato un errore durante l\'aggiunta della prestazione.');
          }
        });
        break;
      case 'option5':
        contentDiv.innerHTML = '<h2>Aggiungi Staff</h2><p>Qui puoi aggiungere membri dello staff.</p>';
        break;
      default:
        contentDiv.innerHTML = '<p>Seleziona un\'opzione valida dal menu a tendina.</p>';
    }
  }
  // Aggiungi un listener per il cambiamento del selettore
  selector.addEventListener('change', function() {
    loadContent(this.value);
  });
  function onScanSuccess(qrMessage) {
    document.getElementById("result").innerText = "QR trovato: " + qrMessage;

    // Chiamata al backend per validare il biglietto
    fetch('/api/checkin', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr: qrMessage })
    })
            .then(res => res.json())
            .then(data => {
              document.getElementById("result").innerText = data.message;
            })
            .catch(err => {
              document.getElementById("result").innerText = "Errore: " + err.message;
            });
  }

  const html5QrCode = new Html5Qrcode("reader");
  html5QrCode.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: 250 },
          onScanSuccess
  );
</script>
</body>
</html>
